# Versioning Feature Progress

## 2026-01-01: Database Schema for Versioning

### Work Done
Added foundational database schema for course versioning:

1. **New `repoVersions` table**
   - id, repoId, name, createdAt
   - Cascade delete from repos
   - Relations to repos and sections

2. **Updated `sections` table**
   - Added optional `repoVersionId` field (for gradual migration)
   - Added `previousVersionSectionId` for changelog tracking
   - Kept `repoId` for backward compatibility during migration

3. **Updated `lessons` table**
   - Added `previousVersionLessonId` for changelog tracking

4. **Added relations**
   - repoVersionsRelations: repo <-> sections
   - Updated reposRelations to include versions
   - Updated sectionsRelations to include repoVersion

### Next Steps
- Implement version selector UI
- Implement "Create New Version" functionality

### PRD Status
All features still marked as `passes: false` - schema is foundation only.
Most important next feature: "Migration creates v1.0 for existing repos"

---

## 2026-01-01: Migration Endpoint and DBService Version Methods

### Work Done
Added migration endpoint and version management methods:

1. **New migration endpoint: POST /api/repos/migrate-to-versions**
   - Gets all repos without versions
   - Creates v1.0 repoVersion for each
   - Updates all sections to point to repoVersionId
   - Returns count of migrated/skipped repos

2. **DBService version methods**
   - `getRepoVersions(repoId)` - list all versions for repo, ordered by date desc
   - `getLatestRepoVersion(repoId)` - get most recent version
   - `getRepoVersionById(versionId)` - get specific version
   - `createRepoVersion({repoId, name})` - create new version

3. **Updated createSections**
   - Now accepts optional `repoVersionId` parameter
   - Sections can be created with version association

### PRD Status
1 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"

### Next Steps
- Implement version selector UI in sidebar
- Implement "Create New Version" functionality

---

## 2026-01-01: Cascade Deletion Through Version Hierarchy

### Work Done
Verified and tested cascade deletion works through the version hierarchy:

1. **Added `deleteRepo` method to DBService**
   - Deletes a repo by ID
   - Cascade configured at schema level handles all child entities

2. **Schema cascade configuration verified**
   - `repoVersions`: CASCADE from `repos`
   - `sections`: CASCADE from both `repos` and `repoVersions`
   - `lessons`: CASCADE from `sections`
   - `videos`: CASCADE from `lessons`
   - `clips`: CASCADE from `videos`

3. **Added integration test**
   - `db-service.test.ts` verifies full cascade: repo -> versions -> sections -> lessons -> videos -> clips
   - Test requires DATABASE_URL to be set

### PRD Status
2 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"
- ✅ "Cascade deletion works through version hierarchy"

### Next Steps
- Implement version selector UI in sidebar
- Implement "Create New Version" functionality
